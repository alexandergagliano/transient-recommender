{% extends "base.html" %}

{% block title %}Admin - Transient Recommender{% endblock %}

{% block extra_head %}
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/material.min.css" rel="stylesheet">
    <style>
        .nav-tabs .nav-link {
            color: #212529 !important;
            font-weight: 500;
        }
        .nav-tabs .nav-link:hover {
            color: #0d6efd !important;
        }
        .nav-tabs .nav-link.active {
            color: #0d6efd !important;
            font-weight: 600;
        }
        .algorithm-card {
            border-left: 4px solid #e9ecef;
            transition: all 0.3s ease;
        min-height: 300px; /* Ensure adequate height */
        }
        .algorithm-card.enabled {
            border-left-color: #198754;
        }
        .algorithm-card.disabled {
            border-left-color: #dc3545;
        }
    .algorithm-card .card-body {
        display: flex;
        flex-direction: column;
        height: 100%;
    }
    .algorithm-card .code-preview {
        flex-grow: 1;
        min-height: 150px;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 12px;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.85em;
        color: #6c757d;
        overflow-y: auto;
        white-space: pre-wrap;
        margin-top: auto;
    }
    .algorithm-card .code-preview.no-code {
        color: #adb5bd;
        font-style: italic;
        display: flex;
        align-items: center;
        justify-content: center;
    }
        .code-editor {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
        }
        .validation-error {
            border-color: #dc3545 !important;
        }
        .validation-success {
            border-color: #198754 !important;
        }
        .add-algorithm-card {
        border: 2px dashed #dee2e6 !important;
            background-color: #f8f9fa;
            transition: all 0.3s ease;
        min-height: 300px;
        display: flex;
        align-items: center;
        justify-content: center;
        }
        .add-algorithm-card:hover {
        border-color: #0d6efd !important;
            background-color: #e7f1ff;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .algorithm-card:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
{% endblock %}

{% block content %}
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1><i class="fas fa-cogs"></i> Admin Panel</h1>
                    <div>
                        <button id="saveConfig" class="btn btn-primary me-2" disabled>
                            <i class="fas fa-save"></i> Save Configuration
                        </button>
                        <button id="resetConfig" class="btn btn-outline-secondary">
                            <i class="fas fa-undo"></i> Reset Changes
                        </button>
                    </div>
                </div>

                <!-- Loading indicator -->
                <div id="loadingIndicator" class="text-center py-5">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading configuration...</span>
                    </div>
                    <p class="mt-2">Loading configuration...</p>
                </div>

                <!-- Section 1: Filter Management -->
                <div id="algorithmManagement" style="display: none;">
                    <!-- Filter Management Header Section -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h2 class="mb-0"><i class="fas fa-filter"></i> Filter Management</h2>
                        </div>
                        <div class="card-body">
                            
                            <!-- Filter Settings Subsection -->
                            <div class="mb-4">
                                <h5 class="border-bottom pb-2 mb-3"><i class="fas fa-cogs"></i> Filter Settings</h5>
                <!-- Science Case Tabs -->
                                <div id="algorithmTabs">
                    <ul class="nav nav-tabs" id="scienceCaseTabs" role="tablist">
                        <!-- Tabs will be populated dynamically -->
                    </ul>
                    
                    <div class="tab-content mt-3" id="scienceCaseTabsContent">
                        <!-- Tab content will be populated dynamically -->
                    </div>
                </div>
                    </div>

                            <!-- Global Filter Settings Subsection -->
                            <div>
                                <h5 class="border-bottom pb-2 mb-3"><i class="fas fa-globe"></i> Global Filter Settings</h5>
                        <div class="row">
                            <div class="col-md-4">
                                <label for="runAfterExtraction" class="form-label">Run After Feature Extraction</label>
                                <select id="runAfterExtraction" class="form-select">
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                        <label for="maxConcurrent" class="form-label">Max Concurrent Filters</label>
                                <input type="number" id="maxConcurrent" class="form-control" min="1" max="10">
                            </div>
                            <div class="col-md-4">
                                <label for="logLevel" class="form-label">Log Level</label>
                                <select id="logLevel" class="form-select">
                                    <option value="DEBUG">DEBUG</option>
                                    <option value="INFO">INFO</option>
                                    <option value="WARNING">WARNING</option>
                                    <option value="ERROR">ERROR</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="cacheResults">
                                    <label class="form-check-label" for="cacheResults">
                                                Cache Filter Results
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="cacheDuration" class="form-label">Cache Duration (hours)</label>
                                <input type="number" id="cacheDuration" class="form-control" min="1" max="168">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

                <!-- Section 2: Science Settings -->
                <div id="scienceSettingsSection" style="display: none;">
                    <!-- Science Settings Header Section -->
                    <div class="card mb-4">
                        <div class="card-header bg-success text-white">
                            <h2 class="mb-0"><i class="fas fa-flask"></i> Science Settings</h2>
    </div>
                        <div class="card-body">
                            <p class="text-muted mb-3">
                                Manage science categories that appear in registration checkboxes, user profiles, and recommendation dropdowns.
                            </p>
                            
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="border-bottom pb-2 mb-0"><i class="fas fa-list-alt"></i> Science Categories</h5>
                                <button class="btn btn-success btn-sm" id="addScienceCategory">
                                    <i class="fas fa-plus"></i> Add Science Category
                                </button>
                            </div>
                            
                            <div id="scienceCategoriesList">
                                <!-- Science categories will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
        </div>
    </div>
</div>

<!-- Add Filter Modal -->
    <div class="modal fade" id="addAlgorithmModal" tabindex="-1" aria-labelledby="addAlgorithmModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                <h5 class="modal-title" id="addAlgorithmModalLabel">Add New Filter</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="newAlgorithmForm">
                        <input type="hidden" id="newAlgScienceCase" />
                        <div class="row">
                            <div class="col-md-6">
                            <label for="newAlgName" class="form-label">Filter Name *</label>
                                <input type="text" class="form-control" id="newAlgName" required placeholder="e.g., SUPERPHOT+">
                            </div>
                            <div class="col-md-6">
                                <label for="newAlgUrl" class="form-label">Documentation URL</label>
                                <input type="url" class="form-control" id="newAlgUrl" placeholder="https://github.com/user/repo">
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label for="newAlgThreshold" class="form-label">Confidence Threshold (%)</label>
                            <input type="number" class="form-control" id="newAlgThreshold" value="60" min="0" max="100" step="0.1">
                            </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <label for="newAlgDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="newAlgDescription" rows="2" placeholder="Brief description of what this filter does..."></textarea>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <label for="newAlgCode" class="form-label">Python Code *</label>
                            <textarea class="form-control" id="newAlgCode" rows="15" required placeholder="def my_filter(ztfid, confidence_threshold):
    # Your filter code here
    # Return a dict with custom 'label' and 'score' (0-100)
    return {'label': 'Type Ia Normal', 'score': 85.0}"></textarea>
                            <small class="form-text text-muted">
                                Function should accept 'ztfid' (string) and 'confidence_threshold' (float) parameters and return a dict with custom 'label' (specific to this filter) and 'score' (0-100).
                            </small>
                        </div>
                    </div>
                    <div class="row mt-3">
                            <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="newAlgEnabled" checked>
                                    <label class="form-check-label" for="newAlgEnabled">
                                    Enable filter
                                    </label>
                                </div>
                            </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="newAlgValidateCode">
                                <label class="form-check-label" for="newAlgValidateCode">
                                    Validate code syntax
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="addAlgorithmBtn">Add Filter</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Filter Modal -->
<div class="modal fade" id="editAlgorithmModal" tabindex="-1" aria-labelledby="editAlgorithmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editAlgorithmModalLabel">Edit Filter</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editAlgorithmForm">
                    <input type="hidden" id="editAlgId" />
                    <input type="hidden" id="editAlgScienceCase" />
                    <div class="row">
                        <div class="col-md-6">
                            <label for="editAlgName" class="form-label">Filter Name *</label>
                            <input type="text" class="form-control" id="editAlgName" required>
                        </div>
                        <div class="col-md-6">
                            <label for="editAlgUrl" class="form-label">Documentation URL</label>
                            <input type="url" class="form-control" id="editAlgUrl">
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label for="editAlgThreshold" class="form-label">Confidence Threshold (%)</label>
                            <input type="number" class="form-control" id="editAlgThreshold" min="0" max="100" step="0.1">
                        </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                            <label for="editAlgDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="editAlgDescription" rows="2"></textarea>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                            <label for="editAlgCode" class="form-label">Python Code *</label>
                            <textarea class="form-control" id="editAlgCode" rows="15" required></textarea>
                            <small class="form-text text-muted">
                                Function should accept 'ztfid' (string) and 'confidence_threshold' (float) parameters and return a dict with custom 'label' (specific to this filter) and 'score' (0-100).
                            </small>
                                </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editAlgEnabled">
                                <label class="form-check-label" for="editAlgEnabled">
                                    Enable filter
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editAlgValidateCode">
                                <label class="form-check-label" for="editAlgValidateCode">
                                    Validate code syntax
                                </label>
                            </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger me-auto" id="deleteAlgorithmBtn">Delete Filter</button>
                <button type="button" class="btn btn-primary" id="updateAlgorithmBtn">Update Filter</button>
                </div>
            </div>
        </div>
    </div>

<!-- Add/Edit Science Category Modal -->
<div class="modal fade" id="scienceCategoryModal" tabindex="-1" aria-labelledby="scienceCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="scienceCategoryModalLabel">Add Science Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
    </div>
            <div class="modal-body">
                <form id="scienceCategoryForm">
                    <input type="hidden" id="editCategoryId" />
                    <div class="mb-3">
                        <label for="categoryKey" class="form-label">Category Key *</label>
                        <input type="text" class="form-control" id="categoryKey" required 
                               placeholder="e.g., snia-like" pattern="[a-z0-9-]+" 
                               title="Use lowercase letters, numbers, and hyphens only">
                        <small class="form-text text-muted">
                            Internal identifier (lowercase, hyphens allowed). Used in URLs and backend.
                        </small>
                    </div>
                    <div class="mb-3">
                        <label for="categoryDisplayName" class="form-label">Display Name *</label>
                        <input type="text" class="form-control" id="categoryDisplayName" required 
                               placeholder="e.g., SN Ia-like">
                        <small class="form-text text-muted">
                            Human-readable name shown in UI.
                        </small>
                    </div>
                    <div class="mb-3">
                        <label for="categoryDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="categoryDescription" rows="3" 
                                  placeholder="Brief description of this science category..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="categoryLikedZtfids" class="form-label">Liked ZTFIDs</label>
                        <textarea class="form-control" id="categoryLikedZtfids" rows="2" 
                                  placeholder="Comma-separated list of ZTFIDs that are good examples of this category (e.g., ZTF18abcdefg, ZTF19hijklmn)"></textarea>
                        <small class="form-text text-muted">
                            Optional: Add ZTFIDs that are good representatives of this science category.
                        </small>
                    </div>
                    <div class="mb-3">
                        <label for="categoryDislikedZtfids" class="form-label">Disliked ZTFIDs</label>
                        <textarea class="form-control" id="categoryDislikedZtfids" rows="2" 
                                  placeholder="Comma-separated list of ZTFIDs that should NOT be in this category (e.g., ZTF20opqrstu, ZTF21vwxyzab)"></textarea>
                        <small class="form-text text-muted">
                            Optional: Add ZTFIDs that are NOT good examples of this science category.
                        </small>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="categoryEnabled" checked>
                        <label class="form-check-label" for="categoryEnabled">
                            Enable category
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger me-auto" id="deleteCategoryBtn" style="display: none;">Delete Category</button>
                <button type="button" class="btn btn-primary" id="saveCategoryBtn">Add Category</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <script>
// Algorithm Management JavaScript
let algorithmConfig = {};
        let hasUnsavedChanges = false;
let codeEditors = {};

        document.addEventListener('DOMContentLoaded', function() {
    loadAlgorithmConfiguration();
            setupEventListeners();
        });

        function setupEventListeners() {
    // Save configuration
            document.getElementById('saveConfig').addEventListener('click', saveConfiguration);
    
    // Reset configuration
            document.getElementById('resetConfig').addEventListener('click', resetConfiguration);
    
    // Add algorithm
    document.getElementById('addAlgorithmBtn').addEventListener('click', addNewAlgorithm);
    
    // Update algorithm
    document.getElementById('updateAlgorithmBtn').addEventListener('click', updateAlgorithm);
    
    // Delete algorithm
    document.getElementById('deleteAlgorithmBtn').addEventListener('click', deleteAlgorithm);
    
    // Science category management
    document.getElementById('saveCategoryBtn').addEventListener('click', saveCategory);
    document.getElementById('deleteCategoryBtn').addEventListener('click', deleteCategory);
    
    // Global settings change tracking
    ['runAfterExtraction', 'maxConcurrent', 'logLevel', 'cacheResults', 'cacheDuration'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('change', markAsChanged);
        }
    });
}

function markAsChanged() {
    hasUnsavedChanges = true;
    document.getElementById('saveConfig').disabled = false;
}

async function loadAlgorithmConfiguration() {
            try {
                const response = await fetch('/api/admin/algorithm-config');
        if (response.ok) {
            algorithmConfig = await response.json();
            renderConfiguration();
            hideLoading();
        } else {
            throw new Error('Failed to load configuration');
        }
            } catch (error) {
                console.error('Error loading algorithm configuration:', error);
                showToast('Error loading algorithm configuration', 'error');
        hideLoading();
    }
}

function renderConfiguration() {
    renderTabs();
    renderGlobalSettings();
    renderScienceSettings();
}

function renderTabs() {
            const tabsContainer = document.getElementById('scienceCaseTabs');
            const contentContainer = document.getElementById('scienceCaseTabsContent');
            
            tabsContainer.innerHTML = '';
            contentContainer.innerHTML = '';
            
    // Get science cases from science_categories (enabled ones) or fallback to filters
    let scienceCases = [];
    if (algorithmConfig.science_categories && algorithmConfig.science_categories.length > 0) {
        scienceCases = algorithmConfig.science_categories
            .filter(cat => cat.enabled)
            .map(cat => cat.key);
    } else {
        scienceCases = Object.keys(algorithmConfig.filters || {});
    }
            
            scienceCases.forEach((scienceCase, index) => {
        // Get display name from science categories if available
        let displayName = scienceCase.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
        if (algorithmConfig.science_categories) {
            const category = algorithmConfig.science_categories.find(cat => cat.key === scienceCase);
            if (category) {
                displayName = category.display_name;
            }
        }
                
                // Create tab
                const tab = document.createElement('li');
                tab.className = 'nav-item';
                tab.innerHTML = `
            <button class="nav-link ${index === 0 ? 'active' : ''}" 
                    id="${scienceCase}-tab" 
                            data-bs-toggle="tab" 
                    data-bs-target="#${scienceCase}-content" 
                    type="button">
                ${displayName}
                    </button>
                `;
                tabsContainer.appendChild(tab);
                
        // Create content
                const content = document.createElement('div');
        content.className = `tab-pane fade ${index === 0 ? 'show active' : ''}`;
        content.id = `${scienceCase}-content`;
        content.innerHTML = renderScienceCaseContent(scienceCase);
                contentContainer.appendChild(content);
            });
        }

function renderScienceCaseContent(scienceCase) {
    const algorithms = algorithmConfig.filters[scienceCase] || [];
    
    // Get display name from science categories if available
    let displayName = scienceCase.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
    if (algorithmConfig.science_categories) {
        const category = algorithmConfig.science_categories.find(cat => cat.key === scienceCase);
        if (category) {
            displayName = category.display_name;
        }
    }
    
    let content = `
        <div class="mb-4">
            <h4>${displayName} Filters</h4>
        </div>
    `;
    
    algorithms.forEach(algorithm => {
        const createdBy = algorithm.created_by || 'Unknown';
        const createdDate = algorithm.created_date ? new Date(algorithm.created_date).toLocaleDateString() : 'Unknown';
        
        content += `
            <div class="mb-4">
                <div class="card algorithm-card ${algorithm.enabled ? 'enabled' : 'disabled'}">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0">${algorithm.name}</h6>
                            <small class="text-muted">Created by ${createdBy} on ${createdDate}</small>
                        </div>
                        <div>
                            <span class="badge bg-${algorithm.enabled ? 'success' : 'secondary'} me-2">
                                ${algorithm.enabled ? 'Enabled' : 'Disabled'}
                            </span>
                            <button class="btn btn-sm btn-outline-primary" onclick="editFilter('${scienceCase}', ${algorithm.id})">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-12">
                                <p class="text-muted mb-2">${algorithm.description || 'No description provided'}</p>
                                <div class="d-flex gap-3">
                                    <small><strong>Threshold:</strong> ${algorithm.threshold}%</small>
                                    ${algorithm.url ? `<small><a href="${algorithm.url}" target="_blank"><i class="fas fa-external-link-alt"></i> Documentation</a></small>` : ''}
                                </div>
                            </div>
                            </div>
                        <div class="row">
                            <div class="col-12">
                                <label class="form-label small text-muted">Python Implementation (Read-only - click Edit to modify)</label>
                                ${(algorithm.code || algorithm.python_code) ? `
                                    <div class="code-preview">${escapeHtml(algorithm.code || algorithm.python_code)}</div>
                                ` : '<div class="code-preview no-code">No code provided</div>'}
                            </div>
                            </div>
                        </div>
                                </div>
                            </div>
        `;
    });
    
    content += `
        <div class="mb-3">
            <div class="card add-algorithm-card border-2 border-dashed d-flex align-items-center justify-content-center" 
                 onclick="showAddFilterModal('${scienceCase}')" 
                 style="cursor: pointer; min-height: 120px;">
                <div class="text-center">
                    <i class="fas fa-plus fa-2x text-primary mb-2"></i>
                    <h6 class="text-primary mb-0">Add New Filter</h6>
                    <small class="text-muted">Click to create a new filter for ${scienceCase.replace('-', ' ')}</small>
                        </div>
                    </div>
                </div>
            `;
    
    return content;
}

function renderGlobalSettings() {
    const settings = algorithmConfig.settings || {};
    
    document.getElementById('runAfterExtraction').value = settings.run_after_extraction || 'true';
    document.getElementById('maxConcurrent').value = settings.max_concurrent || 3;
    document.getElementById('logLevel').value = settings.log_level || 'INFO';
    document.getElementById('cacheResults').checked = settings.cache_results || false;
    document.getElementById('cacheDuration').value = settings.cache_duration_hours || 24;
}

function showAddFilterModal(scienceCase) {
            document.getElementById('newAlgScienceCase').value = scienceCase;
    document.getElementById('addAlgorithmModalLabel').textContent = `Add Filter for ${scienceCase.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}`;
            
            // Reset form
            document.getElementById('newAlgorithmForm').reset();
    document.getElementById('newAlgEnabled').checked = true;
    document.getElementById('newAlgThreshold').value = 60;
    
    // Set default reLAISS code for anomalous science case
    if (scienceCase === 'anomalous') {
        document.getElementById('newAlgName').value = 'reLAISS';
        document.getElementById('newAlgDescription').value = 'Anomaly filter using light curve morphology';
        document.getElementById('newAlgUrl').value = 'https://github.com/alexandergagliano/reLAISS';
        document.getElementById('newAlgCode').value = `def reLAISS_filter(ztfid, confidence_threshold):
    """
    reLAISS anomaly detection filter using actual implementation
    Returns anomaly score based on light curve morphology
    """
    import sys
    import numpy as np
    sys.path.append('./laiss_final/re-laiss/src')
    
    try:
        import relaiss
        from relaiss.anomaly import anomaly_detection
        
        # Initialize reLAISS client
        client = relaiss.ReLAISS()
        
        # Load reference with 25 light curve features
        client.load_reference(
            lc_features=[
                'mean_g-r', 'g_peak_mag', 'r_peak_mag', 'g_amplitude', 'r_amplitude', 
                'g-r_at_g_peak', 'mean_color_rate', 'g_peak_time', 'r_peak_time', 
                'g_rise_time', 'r_rise_time', 'g_decline_time', 'r_decline_time', 
                'g_duration_above_half_flux', 'r_duration_above_half_flux', 
                'g_beyond_2sigma', 'r_beyond_2sigma', 'g_mean_rolling_variance', 
                'r_mean_rolling_variance', 'g_n_peaks', 'r_n_peaks', 
                'g_rise_local_curvature', 'g_decline_local_curvature', 
                'r_rise_local_curvature', 'r_decline_local_curvature'
            ],
            host_features=[],
            path_to_sfd_folder='./data/sfddata-master',
            force_recreation_of_index=True,
            building_for_AD=True, 
            num_trees=1000, 
            use_pca=False, 
            weight_lc=1.0 
        )
        
        # Run anomaly detection
        mjd_anom, anom_scores, norm_scores = anomaly_detection(
            client=client,
            transient_ztf_id=ztfid,
            lc_features=client.lc_features,
            host_features=[],
            path_to_timeseries_folder="./laiss_final/timeseries", 
            path_to_sfd_folder='./data/sfddata-master',         
            path_to_dataset_bank=client.bank_csv,
            path_to_models_directory="./laiss_final/models",       
            save_figures=False,  # No plotting in production
            anom_thresh=30,  
            force_retrain=False,  # Don't retrain in production
            return_scores=True,  # Return the scores
            preprocessed_df=None
        )
        
        # Get maximum anomaly score across all epochs
        max_anomaly_score = np.max(anom_scores) if len(anom_scores) > 0 else 0
        
        # Convert to 0-100 scale and check against threshold
        anomaly_percentage = max_anomaly_score
        
        if anomaly_percentage >= confidence_threshold:
            return {
                'label': 'Anomalous Transient',
                'score': float(anomaly_percentage)
            }
        else:
            return None  # Not anomalous enough
            
    except Exception as e:
        # Fallback in case of errors
        print(f"reLAISS error for {ztfid}: {e}")
        return None`;
    }
            
            new bootstrap.Modal(document.getElementById('addAlgorithmModal')).show();
        }

function editFilter(scienceCase, algorithmId) {
    const algorithm = algorithmConfig.filters[scienceCase].find(alg => alg.id === algorithmId);
    if (!algorithm) return;
    
    document.getElementById('editAlgId').value = algorithmId;
    document.getElementById('editAlgScienceCase').value = scienceCase;
    document.getElementById('editAlgName').value = algorithm.name;
    document.getElementById('editAlgUrl').value = algorithm.url || '';
    document.getElementById('editAlgThreshold').value = algorithm.threshold;
    document.getElementById('editAlgDescription').value = algorithm.description || '';
    document.getElementById('editAlgCode').value = algorithm.code || '';
    document.getElementById('editAlgEnabled').checked = algorithm.enabled;
    
    new bootstrap.Modal(document.getElementById('editAlgorithmModal')).show();
}

async function addNewAlgorithm() {
    const form = document.getElementById('newAlgorithmForm');
    if (!form.checkValidity()) {
        form.reportValidity();
                return;
            }
            
    const scienceCase = document.getElementById('newAlgScienceCase').value;
            const newAlgorithm = {
        id: Date.now(), // Simple ID generation
        name: document.getElementById('newAlgName').value,
        url: document.getElementById('newAlgUrl').value,
        threshold: parseFloat(document.getElementById('newAlgThreshold').value),
        description: document.getElementById('newAlgDescription').value,
        code: document.getElementById('newAlgCode').value,
        enabled: document.getElementById('newAlgEnabled').checked,
        created_by: 'Admin', // TODO: Get actual username from session
        created_date: new Date().toISOString()
    };
    
    if (!algorithmConfig.filters[scienceCase]) {
        algorithmConfig.filters[scienceCase] = [];
    }
    
    algorithmConfig.filters[scienceCase].push(newAlgorithm);
    markAsChanged();
    renderTabs();
            
            bootstrap.Modal.getInstance(document.getElementById('addAlgorithmModal')).hide();
    showToast('Filter added successfully', 'success');
}

async function updateAlgorithm() {
    const form = document.getElementById('editAlgorithmForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const scienceCase = document.getElementById('editAlgScienceCase').value;
    const algorithmId = parseInt(document.getElementById('editAlgId').value);
    
    const algorithm = algorithmConfig.filters[scienceCase].find(alg => alg.id === algorithmId);
    if (!algorithm) return;
    
    algorithm.name = document.getElementById('editAlgName').value;
    algorithm.url = document.getElementById('editAlgUrl').value;
    algorithm.threshold = parseFloat(document.getElementById('editAlgThreshold').value);
    algorithm.description = document.getElementById('editAlgDescription').value;
    algorithm.code = document.getElementById('editAlgCode').value;
    algorithm.enabled = document.getElementById('editAlgEnabled').checked;
    
    markAsChanged();
    renderTabs();
    
    bootstrap.Modal.getInstance(document.getElementById('editAlgorithmModal')).hide();
    showToast('Filter updated successfully', 'success');
}

async function deleteAlgorithm() {
    if (!confirm('Are you sure you want to delete this filter?')) return;
    
    const scienceCase = document.getElementById('editAlgScienceCase').value;
    const algorithmId = parseInt(document.getElementById('editAlgId').value);
    
    algorithmConfig.filters[scienceCase] = algorithmConfig.filters[scienceCase].filter(
        alg => alg.id !== algorithmId
    );
    
    markAsChanged();
    renderTabs();
    
    bootstrap.Modal.getInstance(document.getElementById('editAlgorithmModal')).hide();
    showToast('Filter deleted successfully', 'success');
        }

        async function saveConfiguration() {
            try {
        // Update global settings
        algorithmConfig.settings = {
            run_after_extraction: document.getElementById('runAfterExtraction').value === 'true',
            max_concurrent: parseInt(document.getElementById('maxConcurrent').value),
            log_level: document.getElementById('logLevel').value,
            cache_results: document.getElementById('cacheResults').checked,
            cache_duration_hours: parseInt(document.getElementById('cacheDuration').value)
        };
                
                const response = await fetch('/api/admin/algorithm-config', {
                    method: 'POST',
                    headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(algorithmConfig)
        });
        
        if (response.ok) {
                hasUnsavedChanges = false;
            document.getElementById('saveConfig').disabled = true;
            showToast('Configuration saved successfully', 'success');
        } else {
            throw new Error('Failed to save configuration');
        }
            } catch (error) {
                console.error('Error saving configuration:', error);
        showToast('Error saving configuration', 'error');
            }
        }

        function resetConfiguration() {
    if (hasUnsavedChanges && !confirm('Are you sure you want to reset all changes?')) return;
            
    loadAlgorithmConfiguration();
            hasUnsavedChanges = false;
            document.getElementById('saveConfig').disabled = true;
    showToast('Configuration reset', 'info');
}

function hideLoading() {
    document.getElementById('loadingIndicator').style.display = 'none';
    document.getElementById('algorithmManagement').style.display = 'block';
    document.getElementById('scienceSettingsSection').style.display = 'block';
}

// Science Category Management Functions
function renderScienceSettings() {
    const container = document.getElementById('scienceCategoriesList');
    const scienceCategories = algorithmConfig.science_categories || getDefaultScienceCategories();
    
    let content = '';
    
    scienceCategories.forEach(category => {
        const likedCount = (category.liked_ztfids || []).length;
        const dislikedCount = (category.disliked_ztfids || []).length;
        
        content += `
            <div class="card mb-3 science-category-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">${category.display_name}</h6>
                            <small class="text-muted mb-2 d-block">Key: <code>${category.key}</code></small>
                            <p class="text-muted mb-2 small">${category.description || 'No description provided'}</p>
                            ${likedCount > 0 || dislikedCount > 0 ? `
                                <div class="d-flex gap-3 mb-0">
                                    ${likedCount > 0 ? `<small class="text-success"><i class="fas fa-thumbs-up"></i> ${likedCount} liked</small>` : ''}
                                    ${dislikedCount > 0 ? `<small class="text-danger"><i class="fas fa-thumbs-down"></i> ${dislikedCount} disliked</small>` : ''}
                        </div>
                            ` : ''}
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <span class="badge bg-${category.enabled ? 'success' : 'secondary'}">
                                ${category.enabled ? 'Enabled' : 'Disabled'}
                            </span>
                            <button class="btn btn-sm btn-outline-primary" onclick="editCategory('${category.key}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                        </div>
                    </div>
                    </div>
                </div>
            `;
    });
    
    // Add "Add New Science Case" card
    content += `
        <div class="mb-3">
            <div class="card add-algorithm-card border-2 border-dashed d-flex align-items-center justify-content-center" 
                 onclick="showAddCategoryModal()" 
                 style="cursor: pointer; min-height: 120px;">
                <div class="text-center">
                    <i class="fas fa-plus fa-2x text-primary mb-2"></i>
                    <h6 class="text-primary mb-0">Add New Science Case</h6>
                    <small class="text-muted">Click to create a new science category</small>
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = content;
}

function getDefaultScienceCategories() {
    return [
        { key: 'snia-like', display_name: 'SN Ia-like', description: 'Type Ia supernova candidates', enabled: true },
        { key: 'ccsn-like', display_name: 'CCSN-like', description: 'Core-collapse supernova candidates', enabled: true },
        { key: 'anomalous', display_name: 'Anomalous', description: 'Unusual or anomalous transients', enabled: true },
        { key: 'long-lived', display_name: 'Long-Lived', description: 'Long-duration transients', enabled: true },
        { key: 'precursor', display_name: 'Precursor', description: 'Pre-supernova activity', enabled: true }
    ];
}

function showAddCategoryModal() {
    document.getElementById('scienceCategoryModalLabel').textContent = 'Add Science Category';
    document.getElementById('editCategoryId').value = '';
    document.getElementById('scienceCategoryForm').reset();
    document.getElementById('categoryEnabled').checked = true;
    document.getElementById('categoryLikedZtfids').value = '';
    document.getElementById('categoryDislikedZtfids').value = '';
    document.getElementById('deleteCategoryBtn').style.display = 'none';
    document.getElementById('saveCategoryBtn').textContent = 'Add Category';
    document.getElementById('categoryKey').disabled = false;
    
    new bootstrap.Modal(document.getElementById('scienceCategoryModal')).show();
}

function editCategory(categoryKey) {
    const scienceCategories = algorithmConfig.science_categories || getDefaultScienceCategories();
    const category = scienceCategories.find(cat => cat.key === categoryKey);
    if (!category) return;
    
    document.getElementById('scienceCategoryModalLabel').textContent = 'Edit Science Category';
    document.getElementById('editCategoryId').value = categoryKey;
    document.getElementById('categoryKey').value = category.key;
    document.getElementById('categoryDisplayName').value = category.display_name;
    document.getElementById('categoryDescription').value = category.description || '';
    document.getElementById('categoryLikedZtfids').value = (category.liked_ztfids || []).join(', ');
    document.getElementById('categoryDislikedZtfids').value = (category.disliked_ztfids || []).join(', ');
    document.getElementById('categoryEnabled').checked = category.enabled;
    document.getElementById('deleteCategoryBtn').style.display = 'block';
    document.getElementById('saveCategoryBtn').textContent = 'Update Category';
    document.getElementById('categoryKey').disabled = true; // Don't allow changing key of existing category
    
    new bootstrap.Modal(document.getElementById('scienceCategoryModal')).show();
}

async function saveCategory() {
    const form = document.getElementById('scienceCategoryForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const editingKey = document.getElementById('editCategoryId').value;
    // Parse ZTFIDs from comma-separated strings
    const likedZtfidsText = document.getElementById('categoryLikedZtfids').value.trim();
    const dislikedZtfidsText = document.getElementById('categoryDislikedZtfids').value.trim();
    
    const likedZtfids = likedZtfidsText ? 
        likedZtfidsText.split(',').map(id => id.trim()).filter(id => id.length > 0) : [];
    const dislikedZtfids = dislikedZtfidsText ? 
        dislikedZtfidsText.split(',').map(id => id.trim()).filter(id => id.length > 0) : [];
    
    const categoryData = {
        key: document.getElementById('categoryKey').value,
        display_name: document.getElementById('categoryDisplayName').value,
        description: document.getElementById('categoryDescription').value,
        liked_ztfids: likedZtfids,
        disliked_ztfids: dislikedZtfids,
        enabled: document.getElementById('categoryEnabled').checked
    };
    
    if (!algorithmConfig.science_categories) {
        algorithmConfig.science_categories = getDefaultScienceCategories();
    }
    
    let isNewCategory = false;
    
    if (editingKey) {
        // Update existing category
        const index = algorithmConfig.science_categories.findIndex(cat => cat.key === editingKey);
        if (index !== -1) {
            algorithmConfig.science_categories[index] = categoryData;
        }
    } else {
        // Add new category
        // Check if key already exists
        if (algorithmConfig.science_categories.find(cat => cat.key === categoryData.key)) {
            showToast('Category key already exists', 'error');
            return;
        }
        algorithmConfig.science_categories.push(categoryData);
        isNewCategory = true;
        
        // Initialize empty filters array for new category
        if (!algorithmConfig.filters) {
            algorithmConfig.filters = {};
        }
        if (!algorithmConfig.filters[categoryData.key]) {
            algorithmConfig.filters[categoryData.key] = [];
        }
    }
    
    markAsChanged();
    renderScienceSettings();
    
    // If we added a new category, refresh the algorithm tabs to show the new category
    if (isNewCategory) {
        renderTabs();
    }
    
    bootstrap.Modal.getInstance(document.getElementById('scienceCategoryModal')).hide();
    showToast(editingKey ? 'Category updated successfully' : 'Category added successfully', 'success');
}

async function deleteCategory() {
    const categoryKey = document.getElementById('editCategoryId').value;
    if (!confirm(`Are you sure you want to delete the "${categoryKey}" science category? This will also remove any associated algorithms.`)) {
        return;
    }
    
    if (!algorithmConfig.science_categories) {
        algorithmConfig.science_categories = getDefaultScienceCategories();
    }
    
    // Remove the category
    algorithmConfig.science_categories = algorithmConfig.science_categories.filter(
        cat => cat.key !== categoryKey
    );
    
    // Remove any filters for this category
    if (algorithmConfig.filters && algorithmConfig.filters[categoryKey]) {
        delete algorithmConfig.filters[categoryKey];
    }
    
    markAsChanged();
    renderConfiguration(); // Re-render everything since we removed filters too
    
    bootstrap.Modal.getInstance(document.getElementById('scienceCategoryModal')).hide();
    showToast('Category deleted successfully', 'success');
}

// Utility function to escape HTML
function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
    };
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}

// Use the showToast function from app.js (automatically available in global scope)
// Cache buster: 2025-01-08-1438
    </script>
{% endblock %} 